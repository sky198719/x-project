define(["base"],function(e){return e.extend({handleError:function(t,o,n,r){t.error&&t.error.call(t.context||t,o,n,r),t.global&&(t.context?e(t.context):e.event).trigger("ajaxError",[o,t,r])},createUploadIframe:function(t,o){var n="jUploadFrame"+t,r='<iframe id="'+n+'" name="'+n+'" style="position:absolute; top:-9999px; left:-9999px"';return window.ActiveXObject&&("boolean"==typeof o?r+=' src="javascript:false"':"string"==typeof o&&(r+=' src="'+o+'"')),r+=" />",e(r).appendTo(document.body),e("#"+n).get(0)},createUploadForm:function(t,o,n){var r="jUploadForm"+t,a="jUploadFile"+t,c=e('<form  action="" method="POST" name="'+r+'" id="'+r+'" enctype="multipart/form-data"></form>');if(n)for(var l in n)e('<input type="hidden" name="'+l+'" value="'+n[l]+'" />').appendTo(c);var d=e("#"+o),i=e(d).clone();return e(d).attr("id",a),e(d).before(i),e(d).appendTo(c),e(c).css("position","absolute"),e(c).css("top","-1200px"),e(c).css("left","-1200px"),e(c).appendTo("body"),c},ajaxFileUpload:function(t){t=e.extend({},e.ajaxSettings,t);var o=(new Date).getTime(),n=e.createUploadForm(o,t.fileElementId,void 0!==t.data&&t.data),r=(e.createUploadIframe(o,t.secureuri),"jUploadFrame"+o),a="jUploadForm"+o;t.global&&!e.active++&&e.event.trigger("ajaxStart");var c=!1,l={};t.global&&e.event.trigger("ajaxSend",[l,t]);var d=function(o){var a=document.getElementById(r);try{a.contentWindow?(l.responseText=a.contentWindow.document.body?a.contentWindow.document.body.innerHTML:null,l.responseXML=a.contentWindow.document.XMLDocument?a.contentWindow.document.XMLDocument:a.contentWindow.document):a.contentDocument&&(l.responseText=a.contentDocument.document.body?a.contentDocument.document.body.innerHTML:null,l.responseXML=a.contentDocument.document.XMLDocument?a.contentDocument.document.XMLDocument:a.contentDocument.document)}catch(o){e.handleError(t,l,null,o)}if(l||"timeout"==o){c=!0;var d;try{if("error"!=(d="timeout"!=o?"success":"error")){var i=e.uploadHttpData(l,t.dataType);t.success&&t.success(i,d),t.global&&e.event.trigger("ajaxSuccess",[l,t])}else e.handleError(t,l,d)}catch(o){d="error",e.handleError(t,l,d,o)}t.global&&e.event.trigger("ajaxComplete",[l,t]),t.global&&!--e.active&&e.event.trigger("ajaxStop"),t.complete&&t.complete(l,d),e(a).unbind(),setTimeout(function(){try{e(a).remove(),e(n).remove()}catch(o){e.handleError(t,l,null,o)}},100),l=null}};t.timeout>0&&setTimeout(function(){c||d("timeout")},t.timeout);try{var n=e("#"+a);e(n).attr("action",t.url),e(n).attr("method","POST"),e(n).attr("target",r),n.encoding?e(n).attr("encoding","multipart/form-data"):e(n).attr("enctype","multipart/form-data"),e(n).submit()}catch(o){e.handleError(t,l,null,o)}return e("#"+r).load(d),{abort:function(){}}},uploadHttpData:function(t,o){var n=!o;return n="xml"==o||n?t.responseXML:t.responseText,"script"==o&&e.globalEval(n),"json"==o&&(n=$.parseJSON($(n).text())),"html"==o&&e("<div>").html(n).evalScripts(),n}}),$.ajaxFileUpload});