define(["base","dialog","registerTpl","trackBase","juicer"],function(e,o,s,i,a){function r(e,o){e.attr("src","/feapi/randCode/createVerifyCode?formtoken="+o+"&s="+(new Date).getTime())}var t;e(document).delegate("#J_sendMobileCode","touchend",function(){var o=e(this);if(!o.hasClass("disable")){var s=e("#J_rUsername").val()||"",i=e("#J_rImgCode").val()||"";e.isDevicePhone()&&e.ajax({url:"/feapi/users/checkMobile",dataType:"json",data:{mobile:s,formtoken:n},type:"post",success:function(a){a&&1==a.code?(e.ajax({url:"/feapi/users/sendSMS",dataType:"json",data:{mobile:s,imgcode:i,formtoken:n},type:"post",success:function(s){function i(){0==a?(o.removeClass("disable"),o.html("发送验证码")):(o.html(a+"S"),setTimeout(function(){i()},1e3),a--)}if(s&&2e5==s.code){e.log("手机短信已经发送!");var a=60;o.addClass("disable"),i()}else e(".mui-register-msg").removeClass("hide").html(s.info)},error:function(o){e.log(o)}}),e(".mui-register-msg").addClass("hide")):0==a.code&&e(".mui-register-msg").removeClass("hide").html(a.info)},error:function(o){e.log(o)}})}}),e(document).delegate("#J_rImgCode","keyup",function(){var o=e(this),s=o.val().length,i=e("#J_sendMobileCode");4==s?i.removeClass("disable"):i.addClass("disable")});var n="";return e(document).delegate("#J_registerImgCode","click",function(){r(e(this),n)}),{show:function(a){var a=a||{};n=a.token;var d=juicer.to_html(s,{});callback=a.callback;return t?(e(".mui-register-msg").addClass("hide").html(""),t.show(),void r(e("#J_registerImgCode"),n)):(t=o({content:d,id:"J_muiRegister",isMove:a.isMove||"",customClass:"mui-dialog-register-custom",confirm:function(o){var s={};s.formtoken=n,s.mobile=e("#J_rUsername").val()||"",s.password=e("#J_rPassword").val()||"",s.smscode=e("#J_smsCode").val()||"",s.imgcode=e("#J_rImgCode").val()||"";var a="";s.mobile?s.password?s.imgcode?s.smscode||(a="请填写手机验证码"):a="请填写图片验证码":a="请填写密码":a="请填写用户名",a?e(".mui-register-msg").removeClass("hide").html(a):e.ajax({url:"/feapi/users/regV3",dataType:"json",data:s,type:"post",success:function(s){var a,r,t=s.code;2e5==t&&(a=s.data)&&(r=a.user)?(isLogin=!0,i.init(r),ga("send","event","注册","注册成功",window.location.href),window.userToken=a.userToken,callback&&callback(a),o.close()):e(".mui-register-msg").removeClass("hide").html(s.info)},error:function(o){e.log(o)}})}}),r(e("#J_registerImgCode"),n),window.dialogMap||(window.dialogMap=e.Map()),window.dialogMap.put("registerDialog",t),void e("#J_muiRegisterToMuiLogin").on("click",function(o){"use strict";var s=window.dialogMap,i=s.get("loginDialog");if(t.close(),i)i&&i.show(),r(e("#J_loginImgCode"),n);else{var d;(d=a.login)&&d.show(a)}o&&event.preventDefault()}))}}});